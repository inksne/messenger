{% extends "authenticated.html" %}

<title>{{ title }}</title>

{% block styles %}
    {{ super() }}
    <style>
        #chat-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh; 
            padding-top: 60px; 
            box-sizing: border-box;
        }

        #messages {
            flex: 1; 
            width: 90%;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background-color: rgba(33, 37, 36, 0.6);
            color: white;
            font-size: 14px;
        }

        #input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
        }

        #message-input {
            flex: 1;
            height: 40px;
            padding: 5px;
            margin-right: 10px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background-color: rgba(33, 37, 36, 0.6);
            color: white;
        }

        #send-button {
            padding: 5px 15px;
            font-size: 14px;
            color: white;
            background-color: rgba(16, 25, 23, 0.8);
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #send-button:hover {
            background-color: rgba(16, 25, 23, 1);
        }
    </style>
{% endblock %}

{% block content %}
<div id="chat-container">
    <div id="messages"></div>
    <div id="input-container">
        <input id="message-input" type="text" placeholder="Введите сообщение..." autocomplete="off">
        <button id="send-button">Отправить</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatId = "{{ chat_id }}";  // Передаем идентификатор чата
    const socket = new WebSocket(`ws://${window.location.host}/authenticated/chat/${chatId}/`);

    socket.onopen = () => {
        addSystemMessage('Соединение установлено');
    };

    socket.onmessage = (event) => {
        const message = event.data;
        addUserMessage(null, message);
    };

    socket.onclose = () => {
        addSystemMessage('Соединение закрыто');
    };

    socket.onerror = (error) => {
        addSystemMessage(`Ошибка: ${error.message}`);
    };

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') sendMessage();
    });

    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        socket.send(message);
        messageInput.value = '';
        addUserMessage('Вы', message);
    }

    function addUserMessage(username, message) {
        const messageElement = document.createElement('div');
        if (username) {
            messageElement.innerHTML = `<strong>${username}:</strong> ${message}`;
        } else {
            messageElement.textContent = message;
        }
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function addSystemMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('system-message');
        messageElement.textContent = message;
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
</script>
{% endblock %}